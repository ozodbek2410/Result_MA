# Changelog - OMR Block Test Fix

## [2026-02-04] - Исправление фильтрации вопросов в блок-тестах при OMR сканировании

### Проблема
- При сканировании QR-кода блок-теста показывались все вопросы (30) вместо вопросов по конфигурации студента (25 по 2 предметам)
- Python скрипт правильно считывал QR-код, но сервер не фильтровал вопросы по выбранным предметам
- Python скрипт находил лишние круги на изображении (27-30 вместо 25), которые не фильтровались

### Изменения

#### `server/src/routes/blockTest.routes.ts`
- **Добавлено**: Сохранение `subjectId` для каждого вопроса в `shuffledQuestions` при создании вариантов
- **Строки**: ~403
- **Код**:
  ```typescript
  shuffled.subjectId = subjectTest.subjectId;
  ```

#### `server/src/routes/omr.routes.ts`
- **Улучшено**: Логика фильтрации вопросов по конфигурации студента
- **Улучшено**: Вычисление `totalQuestions` на основе отфильтрованных вопросов (correctAnswers)
- **ДОБАВЛЕНО**: Фильтрация `detected_answers` и `invalid_answers` по количеству вопросов из QR-кода
  - Ограничивает обработку только первыми N вопросами (из QR-кода)
  - Игнорирует лишние круги, найденные Python скриптом
- **Добавлено**: Подробные логи для отладки
- **Добавлено**: Предупреждение для старых вариантов без `subjectId`
- **Строки**: ~150-250, ~420-480

#### `server/src/scripts/updateBlockTestVariants.ts`
- **Создан**: Новый скрипт для обновления существующих вариантов
- **Функционал**: 
  - Находит варианты блок-тестов без `subjectId`
  - Сопоставляет вопросы с блок-тестом по тексту
  - Добавляет `subjectId` к каждому вопросу
  - Выводит статистику обновления

### Документация
- **Создан**: `FIX_BLOCK_TEST_OMR.md` - подробная документация по исправлению
- **Создан**: `QUICK_FIX_RU.md` - краткая инструкция на русском
- **Создан**: `CHANGELOG_OMR_FIX.md` - этот файл

### Миграция

#### Для новых вариантов
Автоматически работает после перезапуска сервера.

#### Для существующих вариантов
**Вариант 1 (рекомендуется)**: Пересоздать варианты через интерфейс

**Вариант 2**: Запустить скрипт обновления:
```bash
cd server
npx ts-node src/scripts/updateBlockTestVariants.ts
```

### Обратная совместимость
- ✅ Код поддерживает старый формат (без `subjectId`)
- ⚠️ Для старых вариантов выводится предупреждение
- ⚠️ Старые варианты используют все вопросы (как раньше)
- ✅ Рекомендуется пересоздать варианты для правильной работы

### Тестирование
1. Создать новый вариант блок-теста
2. Проверить наличие `subjectId` в `shuffledQuestions`
3. Отсканировать OMR лист
4. Проверить, что показывается правильное количество вопросов
5. Проверить логи сервера

### Технические детали

#### Структура данных (до)
```typescript
shuffledQuestions: [
  {
    text: "...",
    correctAnswer: "A",
    variants: [...]
  }
]
```

#### Структура данных (после)
```typescript
shuffledQuestions: [
  {
    text: "...",
    correctAnswer: "A",
    variants: [...],
    subjectId: ObjectId("...")  // <- ДОБАВЛЕНО
  }
]
```

#### Логика фильтрации
1. Получить конфигурацию студента (`StudentTestConfig`)
2. Определить выбранные предметы и количество вопросов
3. Отфильтровать `shuffledQuestions` по `subjectId`
4. Учесть лимит вопросов для каждого предмета
5. Сформировать `correctAnswers` только для отфильтрованных вопросов
6. Использовать количество `correctAnswers` как `totalQuestions`
7. **Отфильтровать `detected_answers` из Python, оставив только первые `totalQuestions`**
8. **Игнорировать лишние круги, найденные Python скриптом**

### Влияние на производительность
- ✅ Минимальное (добавлено одно поле)
- ✅ Фильтрация выполняется один раз при сканировании
- ✅ Нет дополнительных запросов к БД

### Безопасность
- ✅ Нет изменений в безопасности
- ✅ Все проверки остались на месте

### Известные ограничения
- Старые варианты без `subjectId` будут показывать все вопросы
- Скрипт обновления сопоставляет вопросы по тексту (первые 100 символов)
- Если текст вопроса изменился в блок-тесте, сопоставление может не сработать

### Будущие улучшения
- [ ] Добавить автоматическую миграцию при запуске сервера
- [ ] Добавить валидацию `subjectId` при создании вариантов
- [ ] Добавить UI индикатор для старых вариантов
- [ ] Добавить массовое обновление вариантов через интерфейс
