import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

// ============================================
// –ú–ï–¢–†–ò–ö–ò
// ============================================
// –ö–∞—Å—Ç–æ–º–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—à–∏–±–æ–∫
const errorRate = new Rate('errors');

// ============================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –¢–ï–°–¢–ê
// ============================================
export const options = {
  // –§–∞–∑—ã –Ω–∞–≥—Ä—É–∑–∫–∏ (stages)
  // –ò–∑–º–µ–Ω–∏ duration –∏ target –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
  stages: [
    { duration: '30s', target: 50 },   // –†–∞–∑–≥–æ–Ω: 0 ‚Üí 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ 30 —Å–µ–∫
    { duration: '2m', target: 50 },    // –ü–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 2 –º–∏–Ω—É—Ç—ã
    { duration: '30s', target: 200 },  // –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç: —Ä–µ–∑–∫–∏–π –ø—Ä—ã–∂–æ–∫ –¥–æ 200 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    { duration: '20s', target: 0 },    // –û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ: –≤–æ–∑–≤—Ä–∞—Ç –∫ 0 –∑–∞ 20 —Å–µ–∫
  ],

  // –ü–æ—Ä–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∞ (thresholds)
  // –¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
  thresholds: {
    'errors': ['rate<0.05'],           // –ú–µ–Ω–µ–µ 5% –æ—à–∏–±–æ–∫
    'http_req_duration': ['p(95)<500'], // 95% –∑–∞–ø—Ä–æ—Å–æ–≤ –±—ã—Å—Ç—Ä–µ–µ 500–º—Å
    'http_req_failed': ['rate<0.05'],  // –ú–µ–Ω–µ–µ 5% failed –∑–∞–ø—Ä–æ—Å–æ–≤
  },
};

// ============================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –û–ö–†–£–ñ–ï–ù–ò–Ø
// ============================================
// –ò–∑–º–µ–Ω–∏ BASE_URL –Ω–∞ —Å–≤–æ–π –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
const BASE_URL = 'http://localhost:9999';

// ============================================
// –û–°–ù–û–í–ù–û–ô –°–¶–ï–ù–ê–†–ò–ô –¢–ï–°–¢–ê
// ============================================
export default function () {
  // ----------------------------------------
  // 1. GET –∑–∞–ø—Ä–æ—Å –Ω–∞ health check
  // ----------------------------------------
  const healthResponse = http.get(`${BASE_URL}/api/health`);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è health check
  const healthCheck = check(healthResponse, {
    'Health: —Å—Ç–∞—Ç—É—Å 200': (r) => r.status === 200,
    'Health: –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ < 500–º—Å': (r) => r.timings.duration < 500,
    'Health: –µ—Å—Ç—å —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞': (r) => r.body && r.body.length > 0,
  });
  
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
  errorRate.add(!healthCheck);

  // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (1-3 —Å–µ–∫—É–Ω–¥—ã)
  // –ò–º–∏—Ç–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  sleep(Math.random() * 2 + 1);

  // ----------------------------------------
  // 2. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π GET –∑–∞–ø—Ä–æ—Å –Ω–∞ health check
  // ----------------------------------------
  const healthResponse2 = http.get(`${BASE_URL}/api/health`);

  // –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  const healthCheck2 = check(healthResponse2, {
    'Health2: —Å—Ç–∞—Ç—É—Å 200': (r) => r.status === 200,
    'Health2: –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ < 500–º—Å': (r) => r.timings.duration < 500,
  });

  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
  errorRate.add(!healthCheck2);

  // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–µ–π
  sleep(1);
}

// ============================================
// –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï LIFECYCLE HOOKS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
// ============================================

// –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç–µ—Å—Ç–∞
export function setup() {
  console.log('üöÄ –ó–∞–ø—É—Å–∫ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∞...');
  console.log(`üìç –¶–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä: ${BASE_URL}`);
  return { startTime: new Date() };
}

// –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
export function teardown(data) {
  const endTime = new Date();
  const duration = (endTime - data.startTime) / 1000;
  console.log(`‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ ${duration.toFixed(2)} —Å–µ–∫—É–Ω–¥`);
}
